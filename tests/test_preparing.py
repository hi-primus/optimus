import datetime
from optimus.tests.base import TestBase
from optimus.helpers.json import json_encoding
from optimus.helpers.functions import deep_sort, df_dicts_equal, results_equal


def Timestamp(t):
    return datetime.datetime.strptime(t, "%Y-%m-%d %H:%M:%S")


nan = float("nan")
inf = float("inf")


class TestPreparingStIPandas(TestBase):
    config = {'engine': 'pandas'}
    dict = {('NullType', 'object'): [None, None, None, None, None, None], ('attributes', 'object'): [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]], ('date arrival', 'object'): ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'], ('function(binary)', 'object'): [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')], ('height(ft)', 'float64'): [-28.0, 17.0, 26.0, 13.0, nan, 300.0], ('japanese name', 'object'): [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']], ('last date seen', 'object'): ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'], ('last position seen', 'object'): ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None], ('rank', 'int64'): [10, 7, 7, 8, 10, 8], ('Cybertronian', 'bool'): [True, True, True, True, True, False], ('Date Type', 'datetime64[ns]'): [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')], ('age', 'int64'): [5000000, 5000000, 5000000, 5000000, 5000000, 5000000], ('function', 'object'): ['Leader', 'Espionage', 'Security', 'First Lieutenant', 'None', 'Battle Station'], ('names', 'object'): ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'], ('timestamp', 'datetime64[ns]'): [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')], ('weight(t)', 'float64'): [4.3, 2.0, 4.0, 1.8, 5.7, nan]}
    maxDiff = None

    def test_cols_string_to_index_all(self):
        df = self.df
        result = df.cols.string_to_index(cols="*")
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'NullType_string_to_index': [0, 0, 0, 0, 0, 0],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'attributes_string_to_index': [3, 1, 2, 0, 5, 4],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'date arrival_string_to_index': [0, 0, 0, 0, 0, 0],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'function(binary)_string_to_index': [3, 1, 5, 2, 4, 0],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'height(ft)_string_to_index': [0, 2, 3, 1, 5, 4],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'japanese name_string_to_index': [1, 0, 5, 3, 2, 4],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last date seen_string_to_index': [5, 4, 3, 2, 1, 0],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'last position seen_string_to_index': [1, 0, 3, 2, 4, 4],'rank': [10, 7, 7, 8, 10, 8],'rank_string_to_index': [0, 1, 1, 2, 0, 2],'Cybertronian': [True, True, True, True, True, False],'Cybertronian_string_to_index': [1, 1, 1, 1, 1, 0],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'Date Type_string_to_index': [5, 4, 3, 2, 1, 0],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'age_string_to_index': [0, 0, 0, 0, 0, 0],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'function_string_to_index': [3, 1, 5, 2, 4, 0],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'names_string_to_index': [3, 4, 5, 0, 1, 2],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'timestamp_string_to_index': [0, 0, 0, 0, 0, 0],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan],'weight(t)_string_to_index': [3, 1, 2, 0, 4, 5]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))

    def test_cols_string_to_index_numeric(self):
        df = self.df
        result = df.cols.string_to_index(cols=["rank"])
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'rank': [10, 7, 7, 8, 10, 8],'rank_string_to_index': [0, 1, 1, 2, 0, 2],'Cybertronian': [True, True, True, True, True, False],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))

    def test_cols_string_to_index_string(self):
        df = self.df
        result = df.cols.string_to_index(cols=["names"])
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'rank': [10, 7, 7, 8, 10, 8],'Cybertronian': [True, True, True, True, True, False],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'names_string_to_index': [3, 4, 5, 0, 1, 2],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))

    def test_cols_string_to_index_multiple(self):
        df = self.df
        result = df.cols.string_to_index(cols=["attributes","Date Type","Cybertronian"], output_cols=["at","dt","ct"])
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'at': [3, 1, 2, 0, 5, 4],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'rank': [10, 7, 7, 8, 10, 8],'Cybertronian': [True, True, True, True, True, False],'ct': [1, 1, 1, 1, 1, 0],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'dt': [5, 4, 3, 2, 1, 0],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))

    def test_cols_index_to_string_all(self):
        df = self.df.cols.string_to_index(cols="*")
        result = df.rows.numeric(cols="*")
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'NullType_string_to_index': [0, 0, 0, 0, 0, 0],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'attributes_string_to_index': [3, 1, 2, 0, 5, 4],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'date arrival_string_to_index': [0, 0, 0, 0, 0, 0],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'function(binary)_string_to_index': [3, 1, 5, 2, 4, 0],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'height(ft)_string_to_index': [0, 2, 3, 1, 5, 4],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'japanese name_string_to_index': [1, 0, 5, 3, 2, 4],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last date seen_string_to_index': [5, 4, 3, 2, 1, 0],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'last position seen_string_to_index': [1, 0, 3, 2, 4, 4],'rank': [10, 7, 7, 8, 10, 8],'rank_string_to_index': [0, 1, 1, 2, 0, 2],'Cybertronian': [True, True, True, True, True, False],'Cybertronian_string_to_index': [1, 1, 1, 1, 1, 0],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'Date Type_string_to_index': [5, 4, 3, 2, 1, 0],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'age_string_to_index': [0, 0, 0, 0, 0, 0],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'function_string_to_index': [3, 1, 5, 2, 4, 0],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'names_string_to_index': [3, 4, 5, 0, 1, 2],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'timestamp_string_to_index': [0, 0, 0, 0, 0, 0],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan],'weight(t)_string_to_index': [3, 1, 2, 0, 4, 5]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))
        result = df.cols.index_to_string(cols=['NullType_string_to_index','attributes_string_to_index','date arrival_string_to_index','function(binary)_string_to_index','height(ft)_string_to_index','japanese name_string_to_index','last date seen_string_to_index','last position seen_string_to_index','rank_string_to_index','Cybertronian_string_to_index','Date Type_string_to_index','age_string_to_index','function_string_to_index','names_string_to_index','timestamp_string_to_index','weight(t)_string_to_index'])
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'NullType_string_to_index': [0, 0, 0, 0, 0, 0],'NullType_string_to_index_index_to_string': [None, None, None, None, None, None],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'attributes_string_to_index': [3, 1, 2, 0, 5, 4],'attributes_string_to_index_index_to_string': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'date arrival_string_to_index': [0, 0, 0, 0, 0, 0],'date arrival_string_to_index_index_to_string': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'function(binary)_string_to_index': [3, 1, 5, 2, 4, 0],'function(binary)_string_to_index_index_to_string': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'height(ft)_string_to_index': [0, 2, 3, 1, 5, 4],'height(ft)_string_to_index_index_to_string': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'japanese name_string_to_index': [1, 0, 5, 3, 2, 4],'japanese name_string_to_index_index_to_string': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last date seen_string_to_index': [5, 4, 3, 2, 1, 0],'last date seen_string_to_index_index_to_string': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'last position seen_string_to_index': [1, 0, 3, 2, 4, 4],'last position seen_string_to_index_index_to_string': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'rank': [10, 7, 7, 8, 10, 8],'rank_string_to_index': [0, 1, 1, 2, 0, 2],'rank_string_to_index_index_to_string': [10, 7, 7, 8, 10, 8],'Cybertronian': [True, True, True, True, True, False],'Cybertronian_string_to_index': [1, 1, 1, 1, 1, 0],'Cybertronian_string_to_index_index_to_string': [True, True, True, True, True, False],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'Date Type_string_to_index': [5, 4, 3, 2, 1, 0],'Date Type_string_to_index_index_to_string': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'age_string_to_index': [0, 0, 0, 0, 0, 0],'age_string_to_index_index_to_string': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'function_string_to_index': [3, 1, 5, 2, 4, 0],'function_string_to_index_index_to_string': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'names_string_to_index': [3, 4, 5, 0, 1, 2],'names_string_to_index_index_to_string': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'timestamp_string_to_index': [0, 0, 0, 0, 0, 0],'timestamp_string_to_index_index_to_string': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan],'weight(t)_string_to_index': [3, 1, 2, 0, 4, 5],'weight(t)_string_to_index_index_to_string': [4.3, 2.0, 4.0, 1.8, 5.7, nan]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))

    def test_cols_index_to_string_numeric(self):
        df = self.df.cols.string_to_index(cols=["rank"])
        result = df.rows.numeric(cols="*")
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'rank': [10, 7, 7, 8, 10, 8],'rank_string_to_index': [0, 1, 1, 2, 0, 2],'Cybertronian': [True, True, True, True, True, False],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))
        result = df.cols.index_to_string(cols=['rank_string_to_index'])
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'rank': [10, 7, 7, 8, 10, 8],'rank_string_to_index': [0, 1, 1, 2, 0, 2],'rank_string_to_index_index_to_string': ['10', '7', '7', '8', '10', '8'],'Cybertronian': [True, True, True, True, True, False],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))

    def test_cols_index_to_string_string(self):
        df = self.df.cols.string_to_index(cols=["names"])
        result = df.rows.numeric(cols="*")
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'rank': [10, 7, 7, 8, 10, 8],'Cybertronian': [True, True, True, True, True, False],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'names_string_to_index': [3, 4, 5, 0, 1, 2],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))
        result = df.cols.index_to_string(cols=['names_string_to_index'])
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'rank': [10, 7, 7, 8, 10, 8],'Cybertronian': [True, True, True, True, True, False],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'names_string_to_index': [3, 4, 5, 0, 1, 2],'names_string_to_index_index_to_string': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))

    def test_cols_index_to_string_multiple(self):
        df = self.df.cols.string_to_index(cols=["attributes","Date Type","Cybertronian"], output_cols=["at","dt","ct"])
        result = df.rows.numeric(cols="*")
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'at': [3, 1, 2, 0, 5, 4],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'rank': [10, 7, 7, 8, 10, 8],'Cybertronian': [True, True, True, True, True, False],'ct': [1, 1, 1, 1, 1, 0],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'dt': [5, 4, 3, 2, 1, 0],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))
        result = df.cols.index_to_string(cols=["at","dt","ct"])
        expected = self.create_dataframe(dict={'NullType': [None, None, None, None, None, None],'attributes': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'at': [3, 1, 2, 0, 5, 4],'at_index_to_string': [[8.5344, 4300.0], [5.334, 2000.0], [7.9248, 4000.0], [3.9624, 1800.0], [None, 5700.0], [91.44, None]],'date arrival': ['1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10', '1980/04/10'],'function(binary)': [bytearray(b'Leader'), bytearray(b'Espionage'), bytearray(b'Security'), bytearray(b'First Lieutenant'), bytearray(b'None'), bytearray(b'Battle Station')],'height(ft)': [-28.0, 17.0, 26.0, 13.0, nan, 300.0],'japanese name': [['Inochi', 'Convoy'], ['Bumble', 'Goldback'], ['Roadbuster'], ['Meister'], ['Megatron'], ['Metroflex']],'last date seen': ['2016/09/10', '2015/08/10', '2014/07/10', '2013/06/10', '2012/05/10', '2011/04/10'],'last position seen': ['19.442735,-99.201111', '10.642707,-71.612534', '37.789563,-122.400356', '33.670666,-117.841553', None, None],'rank': [10, 7, 7, 8, 10, 8],'Cybertronian': [True, True, True, True, True, False],'ct': [1, 1, 1, 1, 1, 0],'ct_index_to_string': [True, True, True, True, True, False],'Date Type': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'dt': [5, 4, 3, 2, 1, 0],'dt_index_to_string': [Timestamp('2016-09-10 00:00:00'), Timestamp('2015-08-10 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2013-06-24 00:00:00'), Timestamp('2012-05-10 00:00:00'), Timestamp('2011-04-10 00:00:00')],'age': [5000000, 5000000, 5000000, 5000000, 5000000, 5000000],'function': ['Leader', 'Espionage', 'Security', 'First Lieutenant', None, 'Battle Station'],'names': ['Optimus', 'bumbl#ebéé  ', 'ironhide&', 'Jazz', 'Megatron', 'Metroplex_)^$'],'timestamp': [Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00'), Timestamp('2014-06-24 00:00:00')],'weight(t)': [4.3, 2.0, 4.0, 1.8, 5.7, nan]})
        self.assertTrue(result.equals(expected, decimal=True, assertion=True))

class TestPreparingStIDask(TestPreparingStIPandas):
    config = {'engine': 'dask', 'n_partitions': 1}


class TestPreparingStIPartitionDask(TestPreparingStIPandas):
    config = {'engine': 'dask', 'n_partitions': 2}


try:
    import cudf # pyright: reportMissingImports=false
except:
    pass
else:
    class TestPreparingStICUDF(TestPreparingStIPandas):
        config = {'engine': 'cudf'}


try:
    import dask_cudf # pyright: reportMissingImports=false
except:
    pass
else:
    class TestPreparingStIDC(TestPreparingStIPandas):
        config = {'engine': 'dask_cudf', 'n_partitions': 1}


try:
    import dask_cudf # pyright: reportMissingImports=false
except:
    pass
else:
    class TestPreparingStIPartitionDC(TestPreparingStIPandas):
        config = {'engine': 'dask_cudf', 'n_partitions': 2}


try:
    import pyspark # pyright: reportMissingImports=false
except:
    pass
else:
    class TestPreparingStISpark(TestPreparingStIPandas):
        config = {'engine': 'spark'}


try:
    import vaex # pyright: reportMissingImports=false
except:
    pass
else:
    class TestPreparingStIVaex(TestPreparingStIPandas):
        config = {'engine': 'vaex'}
